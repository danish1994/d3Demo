<html>
<head>
    <style>
        #chart path {
            fill: transparent;
            stroke: black;
        }

        #chart {
            border: 1px solid black;
        }
    </style>
</head>
<body>
<svg id="chart" width="500" height="500">
</svg>
<button onclick="addButton()">Add Box</button>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/interactjs@1.3.4/dist/interact.min.js"></script>
<script>
    const svg = d3.select("#chart");
    let selectedPoint;

    const polygons = [];

    const lines = [];

    function updateSVG () {
        svg.selectAll("*").remove();

        const d3Line = d3.svg
            .line()
            .x(d => d.x)
            .y(d => d.y)
            .interpolate("basis");

        lines.map(({source, target}) => {
            source = getCoordinateByName(source);
            target = getCoordinateByName(target);

            if (source && target) {
                svg
                    .append("path")
                    .attr("stroke-width", 2)
                    .attr("d", d3Line([source, target]));
            }
        });

        polygons.map((polygon, i) => {
            svg
                .append("polygon")
                .on({
                    'click': polygonClick.bind(this, i)
                })
                .attr(
                    "points",
                    polygon.points
                        .map(({x, y}) => {
                            return [x, y].join(",");
                        })
                        .join(",")
                )
                .attr('class', 'draggable')
                .attr('index', i)
                .attr('data-x', polygon.x)
                .attr('data-y', polygon.y)
                .attr("fill:lime;stroke:purple;stroke-width:1")
        });
    }

    function polygonClick (i) {
        if (selectedPoint) {
            if (selectedPoint.name !== polygons[i].name) {
                lines.push({
                    source: selectedPoint.name,
                    target: polygons[i].name
                })
            }
            selectedPoint = undefined;
            updateSVG();
        } else {
            selectedPoint = polygons[i];
        }
    }

    function getCoordinateByName (name) {
        const polygon = findPolygonByName(name);
        if (polygon) {
            return {
                x: polygon.x,
                y: polygon.y
            };
        }
    }

    function findPolygonByName (name) {
        return polygons.find(({name: polygonName}) => polygonName === name);
    }

    function updatePolygonPosition (i, x, y) {
        polygons[i].points = [
            {x: x - 5, y: y - 5},
            {x: x + 5, y: y - 5},
            {x: x + 5, y: y + 5},
            {x: x - 5, y: y + 5}
        ];
        polygons[i].x = x;
        polygons[i].y = y;

        updateSVG();
    }

    function addPolygon (x, y) {
        polygons.push(
            {
                name: polygons.length + 1,
                points: [
                    {x: x - 5, y: y - 5},
                    {x: x + 5, y: y - 5},
                    {x: x + 5, y: y + 5},
                    {x: x - 5, y: y + 5}
                ],
                x,
                y,
            }
        );

        updateSVG();
    }

    updateSVG();

</script>
<script>
    interact('.draggable')
        .draggable({
            inertia: true,
            autoScroll: true,
            onmove: dragMove,
         });

    function dragMove (event) {
        const target = event.target,
            x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
            y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy,
            i = target.getAttribute('index');

        target.style.webkitTransform =
            target.style.transform =
                'translate(' + x + 'px, ' + y + 'px)';

        target.setAttribute('data-x', x);
        target.setAttribute('data-y', y);

        updatePolygonPosition(i, x, y);
    }
</script>
<script>
    function addButton () {
        addPolygon(250, 250);
    }
</script>
<script>
    addPolygon(Math.random() * 500, Math.random() * 500);
    addPolygon(Math.random() * 500, Math.random() * 500);
</script>
</body>
</html>
